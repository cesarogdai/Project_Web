<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Formulario Contacto</title>
    <link rel="stylesheet" href="/public/css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

    {{> nav_reg_log}}
    <style>
      .textContact {
        text-align: center;
        cursor: pointer;
      }
      .tooltip {
        display: none;
        position: absolute;
        background-color: #f1f1f1;
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        z-index: 1;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
      }
    </style>
  </head>

  <body>
    <!--<div class="container">-->
    <h2>Extra Large Modal</h2>

    <!-- Button to Open the Modal -->

    <!-- The Modal -->
    <div class="modal fade" id="modalSchedule">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <!-- Modal Header -->
          <div class="modal-header">
            <h4 class="modal-title">Modal Heading</h4>
            <button type="button" class="close" data-dismiss="modal">
              &times;
            </button>
          </div>

          <!-- Modal Body -->
          <div class="modal-body">
            <p>
              This is an extra-large modal window. You can customize the content
              here.
            </p>
          </div>

          <!-- Modal Footer -->
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="content">
        <div class="container">
          <div
            class="row mainBanner"
            style="
              background-color: #ffefa7;
              display: flex;
              align-items: center;
            "
          >
            <div class="col-lg-8 col-8">
              <div class="text-section" style="margin-top: 150px">
                <p
                  class="paragraph"
                  style="
                    margin-bottom: 0 !important;
                    color: #00000063 !important;
                  "
                >
                  Digital Solutions
                </p>
                <p class="boldPoppins" style="margin-top: 0 !important">
                  Contact Us About ZEMA’s Software solutions
                </p>
                <p class="text" style="margin-top: 30px; text-align: justify">
                  We'd love to show you how you can increase your garment’s
                  security, increase your sales productivity, provide better
                  customer service, or all of the above! Here are a few ways to
                  reach out to our sales team.
                </p>
              </div>
            </div>

            <div
              class="col-lg-3 col-3"
              style="margin-top: 100px; position: relative"
            >
              <div class="image-container">
                <img
                  src="images/contact/img_contact.png"
                  width="100%"
                  height="100%"
                  style="
                    display: block;
                    margin: 0 auto;
                    z-index: 1;
                    position: relative;
                  "
                />
                <svg
                  width="120%"
                  height="120%"
                  viewBox="0 0 421 402"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  style="
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    z-index: 0;
                  "
                >
                  <defs>
                    <linearGradient
                      id="paint0_linear_369_62"
                      x1="210.5"
                      y1="-111"
                      x2="210.5"
                      y2="291"
                      gradientUnits="userSpaceOnUse"
                    >
                      <stop stop-color="white" />
                      <stop offset="1" stop-color="white" stop-opacity="0" />
                    </linearGradient>
                  </defs>
                  <path
                    d="M0 201C0 89.9908 89.9908 0 201 0H220C331.009 0 421 89.9908 421 201C421 312.009 331.009 402 220 402H201C89.9908 402 0 312.009 0 201Z"
                    fill="url(#paint0_linear_369_62)"
                  />
                </svg>
              </div>
            </div>
          </div>
          <div
            class="row"
            style="
              background-color: #ffefa7;
              display: flex;
              align-items: center;
            "
          >
            <div class="col-lg-12 col-12">
              <div class="container">
                <div class="row" style="margin-bottom: 100px">
                  <!-- Card #1 -->
                  <div class="col-lg-4 d-flex align-items-stretch">
                    <div
                      class="container mt-5 text"
                      style="background-color: #ffefa7"
                    >
                      <div
                        class="card text-center h-100"
                        style="
                          margin-bottom: 50px;
                          background-color: #f7f9fc !important;
                        "
                      >
                        <div
                          class="card-header"
                          style="background-color: #f7f9fc; border-bottom: none"
                        >
                          <img
                            src="images/contact/phone_icon.png"
                            width="60px"
                            height="45px"
                          />
                        </div>
                        <div
                          class="card-body"
                          style="padding: 0; background-color: #f7f9fc"
                        >
                          <p
                            class="card-text textContact"
                            style="text-align: center"
                          >
                            Call us directly
                          </p>
                          <p
                            id="phoneNumber"
                            class="textContact"
                            onclick="copyToClipboard()"
                          >
                            +52 722 2958457
                          </p>

                          <a href="test.com"
                            ><p class="paragraph" style="text-align: center">
                              See more local numbers
                            </p></a
                          >
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- Card #2 -->
                  <div class="col-lg-4 d-flex align-items-stretch">
                    <div
                      class="container mt-5 text"
                      style="background-color: #ffefa7"
                    >
                      <div class="card text-center h-100">
                        <div
                          class="card-header"
                          style="background-color: #f7f9fc; border-bottom: none"
                        >
                          <img
                            src="images/contact/msg_icon.png"
                            width="60px"
                            height="45px"
                          />
                        </div>
                        <div
                          class="card-body"
                          style="padding: 0; background-color: #f7f9fc"
                        >
                          <p
                            class="card-text textContact"
                            style="text-align: center; font-weight: 500"
                          >
                            Chat with our sales team
                          </p>
                          <a
                            href="https://example.com/discover-more"
                            class="btnLinkContact"
                            id="chatBtn"
                            >Chat with sales</a
                          >
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- Card #3 -->
                  <div class="col-lg-4 d-flex align-items-stretch">
                    <div
                      class="container mt-5 text"
                      style="background-color: #ffefa7"
                    >
                      <div class="card text-center h-100">
                        <div
                          class="card-header"
                          style="background-color: #f7f9fc; border-bottom: none"
                        >
                          <img
                            src="images/contact/calendar_icon.png"
                            width="60px"
                            height="45px"
                          />
                        </div>
                        <div
                          class="card-body"
                          style="padding: 0; background-color: #f7f9fc"
                        >
                          <p
                            class="card-text textContact"
                            style="text-align: center"
                          >
                            Schedule a demo outfit
                          </p>
                          <a
                            href="https://example.com/discover-more"
                            class="btnLinkContact"
                            id="demoSchedule"
                            >Get a demo outfit</a
                          >
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row" id="chatDiv">
            <div class="content">
              <div id="chat-window">
                <div class="row">
                  <div class="col-lg-8 col-8">
                    <strong>Chat Window</strong>
                  </div>
                  <div class="col-lg-4 col-4" style="text-align: right">
                    <strong
                      ><i
                        class="fa fa-times"
                        style="color: black"
                        id="closeChat"
                      ></i
                    ></strong>
                  </div>
                  <hr />
                </div>
                <!-- Combined container for messages and input/button -->
                <div
                  class="row"
                  id="chat-container"
                  style="flex: 1; overflow-y: auto"
                >
                  <div id="chat-messages"></div>
                  <div id="element">
                    <input
                      type="text"
                      id="chat-input"
                      placeholder="Escriba algo"
                      style="width: 80%; padding: 5px"
                    />
                    <button id="send-btn" style="width: 18%; padding: 5px">
                      Send
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>

<script>
  function copyToClipboard() {
    var copyText = document.getElementById("phoneNumber");
    var tempInput = document.createElement("input");
    tempInput.value = copyText.textContent;
    document.body.appendChild(tempInput);
    tempInput.select();
    tempInput.setSelectionRange(0, 99999);
    document.execCommand("copy");
    document.body.removeChild(tempInput);

    var originalText = copyText.textContent;
    copyText.textContent = "Se ha copiado al portapapeles"; // Change the text to "Se ha copiado"

    setTimeout(function () {
      copyText.textContent = originalText; // Return to the original text
    }, 2000);
  }
</script>

<script>
  $(document).ready(function () {
    let conversationId = 0;

    // TOGGLE CHAT WINDOW
    $("#chatBtn").on("click", function (e) {
      e.preventDefault();
      toggleChatWindow();
    });

    $("#demoSchedule").on("click", function (e) {
      e.preventDefault();
      toggleModal();
    });

    function toggleModal() {
      $("#modalSchedule").modal("show");
      //$()
    }

    function toggleChatWindow() {
      var chatWindow = document.getElementById("chat-window");
      chatWindow.style.display =
        chatWindow.style.display === "none" || chatWindow.style.display === ""
          ? "block"
          : "none";

      // Start retrieving messages every 2 seconds when the chat window is opened
      if (chatWindow.style.display === "block") {
        //startMessageRetrieval();
      }
    }

    $("#closeChat").on("click", function () {
      document.getElementById("chat-window").style.display = "none";
      // Stop retrieving messages when the chat window is closed
      stopMessageRetrieval();
    });

    $("#send-btn").on("click", function () {
      var inputElement = document.getElementById("chat-input");
      var message = inputElement.value;
      inputElement.value = "";
      const messageCount =
        document.getElementById("chat-messages").children.length;

      if (messageCount === 0) {
        firstMessage(message);
      } else {
        otherMessages(message, conversationId);
      }
    });

    function firstMessage(message) {
      $.ajax({
        type: "POST",
        url: "/firstMessage",
        data: { message: message },
        success: function (response) {
          console.log("First message sent: ", response);
          conversationId = response.insertedId;
          // Retrieve and display messages after sending the first message
          startMessageRetrieval();
          retrieveMessages(conversationId);
        },
        error: function (err) {
          console.log("Error sending first message: ", err);
        },
      });
    }
    function otherMessages(message, conversationId) {
      $.ajax({
        url: "post",
        url: "/otherMessages",
        data: { message, conversationId },
        success: function (response) {
          console.log("Other messages sent: ", response);
        },
        error: function (err) {
          console.log("Error sending other messages: ", err);
        },
      });
    }

    // Function to retrieve messages every 2 seconds
    function startMessageRetrieval() {
      // Adjust the interval as needed (2 seconds in this example)
      window.messageRetrievalInterval = setInterval(function () {
        retrieveMessages(conversationId);
      }, 2000);
    }

    // Function to stop retrieving messages
    function stopMessageRetrieval() {
      clearInterval(window.messageRetrievalInterval);
    }

    function retrieveMessages(conversationId) {
      conversationIdNumber = conversationId.insertId;
      $.ajax({
        type: "post",
        url: "/getMessages",
        data: { conversationId: conversationIdNumber },
        success: function (resp) {
          console.log("resp messages: ", resp.data);
          updateChatUI(resp.data); // Move the updateChatUI call here
        },
        error: function (err) {
          console.log("error: ", err);
        },
      });
    }

    function updateChatUI(messages) {
      const chatMessagesContainer = document.getElementById("chat-messages");
      chatMessagesContainer.innerHTML = "";

      if (messages.length > 0) {
        // Sort messages by time
        messages.sort((a, b) => new Date(a.date_sent) - new Date(b.date_sent));

        messages.forEach((message) => {
          // Create message container
          const messageContainer = document.createElement("div");

          // Create message element
          const messageElement = document.createElement("div");
          messageElement.textContent = message.message;
          messageContainer.appendChild(messageElement);

          // Add a class based on the sender
          if (message.sender === 1) {
            messageContainer.classList.add("sent-message", "left-row");
          } else {
            messageContainer.classList.add("received-message", "right-row");
          }

          // Append the message container to the chat messages container
          chatMessagesContainer.appendChild(messageContainer);
        });
      }
      chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
    }
  });
</script>
